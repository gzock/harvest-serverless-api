import boto3
from boto3.dynamodb.conditions import Key, Attr

class DynamoDbDriver():

  def __init__(self, host, port, table_name):
    if not host or not port:
      raise ValueError
    self.__dynamo_host = host
    self.__dynamo_port = port

    try:
      self.dynamodb = self.__connect(self.__dynamo_host, self.__dynamo_port)
      self.table = self.dynamodb.Table(table_name)
    except Exception as e:
      raise e

  def __connect(self, host, port):
    return boto3.resource(
        "dynamodb",
        region_name = "ap-northeast-1",
        endpoint_url = 'http://' + host + ':' + port
    )

  def set_partition_key(self, key):
    if not key:
      raise ValueError
    self.__partition_key = key

  def set_sort_key(self, key):
    if not key:
      raise ValueError
    self.__sort_key = key

  def put_item(self, item):
    return self.table.put_item( Item=item )

  def scan(self):
    return self.table.scan()

  def query(self, partition_key, sort_key = None):
    if partition_key and not sort_key:
      return self.table.query(
          KeyConditionExpression = Key(self.__partition_key).eq(partition_key)
      )
    elif partition_key and sort_key:
      return self.table.query(
          KeyConditionExpression = Key(self.__partition_key).eq(partition_key) & Key(self.__sort_key).eq(sort_key)
      )
    else:
      raise ValueError

  def update_item(
      self, 
      partition_key, 
      update_exp, 
      sort_key = None, 
      exp_attr = None, 
      ret_value="UPDATED_NEW"):

    if partition_key and not sort_key:
      keys = {
           self.__partition_key: partition_key
      }
    elif partition_key and sort_key:
      keys = {
           self.__partition_key: partition_key,
           self.__sort_key: sort,
      }
    else:
      raise ValueError

    return self.__table.update_item(
        Key = keys,
        UpdateExpression = update_exp,
        ExpressionAttributeValues = exp_attr,
        ReturnValues = ret_value
    )

  def update_item_with_condition(
      self, 
      partition_key, 
      update_exp, 
      sort_key = None, 
      exp_attr = None, 
      cond_exp = None, 
      ret_value="UPDATED_NEW"):
    
    if partition_key and not sort_key:
      keys = {
           self.__partition_key: partition_key
      }
    elif partition_key and sort_key:
      keys = {
           self.__partition_key: partition_key,
           self.__sort_key: sort,
      }
    else:
      raise ValueError

    return self.__table.update_item(
        Key = keys,
        UpdateExpression = update_exp,
        ExpressionAttributeValues = exp_attr,
        ConditionExpression = cond_exp,
        ReturnValues = ret_value
    )

  def delete_item(self, partition_key, sort_key = None):
    if partition_key and not sort_key:
      keys = {
           self.__partition_key: partition_key
      }
    elif partition_key and sort_key:
      keys = {
           self.__partition_key: partition_key,
           self.__sort_key: sort,
      }
    else:
      raise ValueError

    return self.__table.delete_item(Key = keys)
