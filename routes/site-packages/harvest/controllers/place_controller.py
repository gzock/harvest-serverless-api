import os, sys
import json
import logging
from uuid import uuid4
from datetime import datetime

from harvest.drivers.dynamodb_driver import DynamoDbDriver
from harvest.exception import *

class PlaceController(DynamoDbDriver):

  logger = logging.getLogger(__name__)
  logger.addHandler(logging.NullHandler())
  logger.setLevel(logging.DEBUG)
  logger.propagate = False

  def __init__(self, host, port):
    super().__init__(host, port, "Places")
    super().set_partition_key("project_id")
    super().set_sort_key("place_id")
#    self.target = TargetController(host, port)
    self.logger.info("################################")

  def set_project_id(self, project_id):
    self.project_id = str(project_id)
#    self.target.set_project_id(str(project_id))
  
  def set_place_id(self, place_id):
    self.place_id = str(place_id)

  def list(self, project_id=None):
    if not project_id and self.project_id:
      project_id = self.project_id

    ret = super().query(
        partition_key = project_id
    )
    return ret["Items"]

  def list_children(self, parent_place_id):
    if not self.project_id or not parent_place_id:
      raise ValueError

    super().set_sort_key("parent_place_id")
    ret = super().query(
        partition_key = self.project_id, 
        sort_key = parent_place_id, 
        index = "ParentPlacesIndex"
    )
    super().set_sort_key("place_id")
    return ret["Items"]

  def show(self, place_id = None):
    if not self.project_id:
      raise ValueError
    if not place_id:
      place_id = self.place_id
    # user_idを使って権限チェック
    return super().get_item(self.project_id, place_id)["Item"]

  def create(self, name, parent_place_id = None):
    if not self.project_id or not name:
      raise ValueError

    if parent_place_id:
      # 親placeを取得
      parent = self.show(parent_place_id)
      hierarchy = parent["hierarchy"]
      if len(hierarchy.split("#")) == 6:
        raise PlaceHierarchyLimitExceededError()

      # ヒエラルキに親place_idを足す
      hierarchy += "#{}".format(parent_place_id)
    else:
      parent_place_id = self.project_id
      hierarchy = self.project_id

    # そのユーザにpj作成権限があるかどうかを確認
    new_id = str(uuid4())
    now = datetime.now().isoformat()

    return super().put_item(
      item = {
        "project_id": self.project_id,
        "place_id": new_id,
        "parent_place_id": parent_place_id,
        "hierarchy": hierarchy,
        "name": str(name),
        "photos": {
          "required": 0,
          "results": {
            "before": 0,
            "after": 0,
          }
        },
        "created_at": now,
        "updated_at": now
      }
    )

  def update_name(self, name):
    if not self.project_id or not self.place_id:
      raise ValueError

    # user_idを使って権限チェック
    now = datetime.now().isoformat()
    return super().update_item(
        partition_key = self.project_id,
        sort_key = self.place_id,
        update_exp = "set #name = :name, #updated_at = :updated_at",
        exp_attr_names = {
            '#name': "name",
            "#updated_at": "updated_at"
        },
        exp_attr_values={
            ":name": name,
            ":updated_at": now

        },
        cond_exp = 'attribute_exists(project_id)'
    )

  def delete(self, place_id=None):
    if not self.project_id or not self.place_id:
      raise ValueError

    if not place_id:
      place_id = self.place_id

    return super().delete_item(self.project_id, self.place_id)

  def delete_all(self):
    if not self.project_id:
      raise ValueError

    places = self.list()
    place_ids = [ {"project_id": self.project_id, "place_id": place["place_id"]} for place in places ]
    return super().batch_del_item(place_ids)

  def batch_create_places(self, places):
    ##TODO: batch_writeが失敗していたときの処理が必要
    return super().batch_put_item(places)
    #loop_cnt = 1
    #if len(places) > 25:
    #  loop_cnt = places / 25
    #  loop_cnt += (places % 25)

    #req_items = []
    #for place in places:
    #  req_items.append(
    #    {
    #      'PutRequest': {
    #        'Item': place
    #      }
    #    }
    #  )
    #results = []
    #for i in range(loop_cnt):
    #  ret = self.dynamodb.batch_write_item(
    #        RequestItems = {
    #          "Places": req_items[:25]
    #        }
    #  )
    #  results.append(ret)
    #  del req_items[:25]
    ##TODO: batch_writeが失敗していたときの処理が必要
    #return results
