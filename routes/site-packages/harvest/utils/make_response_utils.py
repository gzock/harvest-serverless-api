import json
import decimal

from harvest.exception import HarvestAbstractException

def make_response_headers_for_cors():
  return {
      "Access-Control-Allow-Headers": "Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token",
      "Access-Control-Allow-Methods": "OPTIONS,GET,POST,PUT,DELETE",
      "Access-Control-Allow-Origin": "*"
  }
  
def make_base_error_obj():
  return {
    "error": {
      "title": "",
      "message": "",
      "code": 0,
      "ref_url": ""
    }
  }

def make_response(status_code=200, body=None):
  headers = make_response_headers_for_cors()

  if isinstance(body, HarvestAbstractException):
    ret = make_base_error_obj()
    ret["error"]["title"] = body.title
    ret["error"]["code"] = body.code
    ret["error"]["message"] = body.message
    body = ret
  elif isinstance(body, Exception):
    print(body)
    ret = make_base_error_obj()
    ret["error"]["title"] = "Unknown Internal Error"
    ret["error"]["code"] = 999
    ret["error"]["message"] = "unknown internal error."
    body = ret

  try:
    body = json.dumps(body, cls = DecimalEncoder)
  except (NameError, ValueError, TypeError) as e:
    print(e)
    status_code = 500
    body = ""
  finally:
    return {
        "statusCode": status_code,
        "headers": headers,
        "body": body
    }

class DecimalEncoder(json.JSONEncoder):
  def default(self, o):
    if isinstance(o, decimal.Decimal):
      return int(o)
    return super(DecimalEncoder, self).default(o)
